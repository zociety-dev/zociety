#!/bin/bash
# check-genesis: Query state to determine if genesis thresholds are met
# Returns 0 if complete, 1 if incomplete
#
# Uses hybrid approach:
#   - Structured commits ([join], [pass]) if present
#   - Falls back to file-based counting for backwards compatibility

set -e

# Try structured commit counting first
COMMIT_JOINS=$(git log --oneline --grep="^\[join\]" 2>/dev/null | wc -l | tr -d ' ')
COMMIT_RULES=$(git log --oneline --grep="^\[pass\]" 2>/dev/null | wc -l | tr -d ' ')

# Fall back to file-based counting
if [[ -f members.txt ]]; then
  FILE_MEMBERS=$(grep -c . members.txt 2>/dev/null || echo 0)
else
  FILE_MEMBERS=0
fi

if [[ -f rules.txt ]]; then
  # Count lines with ✓ PASSED or ✓ INHERITED
  FILE_RULES=$(grep -c "✓" rules.txt 2>/dev/null) || FILE_RULES=0
else
  FILE_RULES=0
fi

# Use whichever is higher (handles transition period)
if [[ $COMMIT_JOINS -gt $FILE_MEMBERS ]]; then
  MEMBERS=$COMMIT_JOINS
else
  MEMBERS=$FILE_MEMBERS
fi

if [[ $COMMIT_RULES -gt $FILE_RULES ]]; then
  RULES=$COMMIT_RULES
else
  RULES=$FILE_RULES
fi

# Count stuff by tracked files (always reliable)
STUFF=$(git ls-files stuff/ 2>/dev/null | wc -l | tr -d ' ')
if [[ $STUFF -eq 0 && -d stuff ]]; then
  # Fallback: count untracked files too
  STUFF=$(ls -1 stuff/ 2>/dev/null | wc -l | tr -d ' ')
fi

# Thresholds
NEED_MEMBERS=3
NEED_RULES=2
NEED_STUFF=3

echo "Genesis state:" >&2
echo "  Members: $MEMBERS/$NEED_MEMBERS" >&2
echo "  Rules:   $RULES/$NEED_RULES" >&2
echo "  Stuff:   $STUFF/$NEED_STUFF" >&2

if [[ $MEMBERS -ge $NEED_MEMBERS && $RULES -ge $NEED_RULES && $STUFF -ge $NEED_STUFF ]]; then
  echo "  Status:  COMPLETE ✓" >&2
  exit 0
else
  echo "  Status:  INCOMPLETE" >&2
  exit 1
fi
