#!/bin/bash
# zociety: Run Claude Code inside the containerized zociety environment
#
# Usage:
#   bin/zociety                    # Interactive Claude session
#   bin/zociety login              # Login to Claude (Max subscription)
#   bin/zociety bash               # Shell inside container
#   bin/zociety -- [claude args]   # Pass args to claude
#   bin/zociety <any command>      # Run arbitrary command in container

set -e

# Prevent running inside a container - this is a host launcher
reject_container() {
  local in_container=false

  # Method 1: runtime files
  [[ -f /.dockerenv ]] && in_container=true
  [[ -f /run/.containerenv ]] && in_container=true

  # Method 2: environment variable (Podman sets container=podman)
  [[ -n "${container:-}" ]] && in_container=true

  # Method 3: cgroup detection
  if grep -qE '(docker|containerd|kubepods|libpod)' /proc/1/cgroup 2>/dev/null; then
    in_container=true
  fi

  if [[ "$in_container" == "true" ]]; then
    echo "ERROR: This launcher must run on the host, not inside a container." >&2
    echo "Use the zociety scripts directly inside the container." >&2
    exit 1
  fi
}

reject_container

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
CONTAINER_DIR="$PROJECT_DIR/container"
IMAGE_NAME="localhost/zociety:latest"
CONTAINER_NAME="zociety-sandbox"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info()  { echo -e "${GREEN}[zociety]${NC} $1" >&2; }
log_warn()  { echo -e "${YELLOW}[zociety]${NC} $1" >&2; }
log_error() { echo -e "${RED}[zociety]${NC} $1" >&2; }
log_cmd()   { echo -e "${CYAN}[zociety]${NC} $1" >&2; }

check_prereqs() {
    if ! command -v podman &> /dev/null; then
        log_error "podman not found. Install it first:"
        log_error "  brew install podman    # macOS"
        log_error "  apt install podman     # Debian/Ubuntu"
        exit 1
    fi
}

build_image() {
    log_info "Building container image..."
    podman build -t "$IMAGE_NAME" "$CONTAINER_DIR"
    log_info "Image built: $IMAGE_NAME"
}

image_exists() {
    podman image exists "$IMAGE_NAME" 2>/dev/null
}

ensure_image() {
    if ! image_exists; then
        log_warn "Image not found. Building..."
        build_image
    fi
}

run_container() {
    ensure_image
    check_prereqs

    local cmd=("$@")
    if [[ ${#cmd[@]} -eq 0 ]]; then
        cmd=("claude")
    fi

    log_cmd "Running: ${cmd[*]}"

    # Build volume args
    local volume_args=(
        --volume "$PROJECT_DIR:/repo:Z"
        --volume "zociety-claude-home:/home/agent"
    )

    # Add secrets directory if it exists
    if [[ -d "$CONTAINER_DIR/secrets" ]]; then
        volume_args+=(--volume "$CONTAINER_DIR/secrets:/run/secrets:ro")
    fi

    # Add plugins if CLAUDE_PLUGINS_DIR is set
    if [[ -n "${CLAUDE_PLUGINS_DIR:-}" ]] && [[ -d "$CLAUDE_PLUGINS_DIR" ]]; then
        volume_args+=(--volume "$CLAUDE_PLUGINS_DIR:/home/agent/.claude-plugins:ro")
    fi

    podman run --rm -it \
        --name "$CONTAINER_NAME" \
        --read-only \
        --tmpfs /tmp:size=200M,mode=1777 \
        --tmpfs /run:size=50M,mode=755 \
        "${volume_args[@]}" \
        --memory 1g \
        --cpus 2.0 \
        --user 1000:1000 \
        --security-opt no-new-privileges:true \
        "$IMAGE_NAME" \
        "${cmd[@]}"
}

show_help() {
    cat << 'EOF'
zociety - Containerized Claude Code environment

USAGE:
    bin/zociety [command] [args...]

COMMANDS:
    (none)              Start interactive Claude session
    login               Login to Claude (Max subscription)
    bash                Shell inside the container
    exec [cmd]          Exec into running container (default: bash)
    -- [args]           Pass arguments to claude command
    <any>               Run arbitrary command in container

MANAGEMENT:
    --build             Build/rebuild the container image
    --rebuild           Force rebuild (no cache)
    --status            Show image and volume status
    --clean             Remove image and volumes (destructive)
    --help              Show this help

FIRST TIME SETUP (Claude Max):
    bin/zociety --build
    bin/zociety login

RUNNING THE AGENT LOOP:
    CLAUDE_PLUGINS_DIR=~/.claude/plugins bin/zociety -- --dangerously-skip-permissions
    # Then in the Claude session, type:
    /ralph-wiggum:ralph-loop "Read PROMPT.md and follow its instructions." --max-iterations 60 --completion-promise "[output by bin/zpromise]"

PLUGINS:
    Set CLAUDE_PLUGINS_DIR to mount plugins into container:
    CLAUDE_PLUGINS_DIR=~/.claude/plugins bin/zociety

EXAMPLES:
    bin/zociety                                    # Interactive Claude
    bin/zociety -- --dangerously-skip-permissions  # Claude with args
    bin/zociety bash                               # Debug shell
    bin/zociety exec                               # Bash into running container
    bin/zociety exec bin/zstate                    # Run command in running container
    bin/zociety bin/check-genesis                  # Run zociety script
EOF
}

case "${1:-}" in
    --help|-h)
        show_help
        exit 0
        ;;
    --build)
        check_prereqs
        build_image
        exit 0
        ;;
    --rebuild)
        check_prereqs
        log_info "Rebuilding image (no cache)..."
        podman build --no-cache -t "$IMAGE_NAME" "$CONTAINER_DIR"
        log_info "Image rebuilt: $IMAGE_NAME"
        exit 0
        ;;
    --status)
        echo "Image:"
        podman images "$IMAGE_NAME" 2>/dev/null || echo "  Not built"
        echo ""
        echo "Volume:"
        podman volume inspect zociety-claude-home 2>/dev/null | grep -E '(Name|Mountpoint)' || echo "  Not created"
        echo ""
        echo "CLAUDE_PLUGINS_DIR: ${CLAUDE_PLUGINS_DIR:-not set}"
        exit 0
        ;;
    --clean)
        log_warn "This will remove the zociety image and home volume."
        log_warn "You will need to login again after this."
        read -p "Continue? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            podman rm -f "$CONTAINER_NAME" 2>/dev/null || true
            podman volume rm zociety-claude-home 2>/dev/null || true
            podman rmi "$IMAGE_NAME" 2>/dev/null || true
            log_info "Cleaned up"
        else
            log_info "Aborted"
        fi
        exit 0
        ;;
    exec)
        shift
        cmd=("${@:-bash}")
        if ! podman container exists "$CONTAINER_NAME" 2>/dev/null; then
            log_error "Container '$CONTAINER_NAME' is not running."
            log_error "Start it first with: bin/zociety"
            exit 1
        fi
        log_cmd "Exec: ${cmd[*]}"
        podman exec -it "$CONTAINER_NAME" "${cmd[@]}"
        ;;
    login)
        run_container claude login
        ;;
    --)
        # Pass remaining args to claude
        shift
        run_container claude "$@"
        ;;
    *)
        run_container "$@"
        ;;
esac
