#!/bin/bash
# zpromise: Output completion promise
#
# Call this when zstate shows action="promise"
# This happens after heap-death with batch_remaining=0

set -e

# Verify we're in the right state
STATE=$(bin/zstate)
ACTION=$(echo "$STATE" | jq -r '.action')
LAST_EVENT=$(echo "$STATE" | jq -r '.last_event')

if [[ "$ACTION" != "promise" ]]; then
  echo "ERROR: Current action is '$ACTION', not 'promise'" >&2
  echo "Run bin/zstate to see current state" >&2
  exit 1
fi

# Safety check: should only promise after heap-death
if [[ "$LAST_EVENT" != "heap-death" ]]; then
  echo "WARNING: Last event was '$LAST_EVENT', expected 'heap-death'" >&2
  echo "Proceeding anyway..." >&2
fi

echo ""
echo "<promise>CYCLE_COMPLETE</promise>"