#!/bin/bash
# validate-state: Ensure commit follows conventions
# Used by pre-commit hook

set -e

# Get the commit message from staged changes
MSG_FILE="$1"

# If called without arg, we're validating current state not a commit
if [[ -z "$MSG_FILE" ]]; then
  # Basic state validation
  if [[ -f PROMPT.md ]]; then
    echo "✓ PROMPT.md exists"
  else
    echo "✗ PROMPT.md missing"
    exit 1
  fi
  
  # Check for conflicting state
  if [[ -f DIRECTION.md && -f members.txt ]]; then
    # DIRECTION.md should be consumed before genesis starts
    MEMBERS=$(wc -l < members.txt | tr -d ' ')
    if [[ $MEMBERS -gt 1 ]]; then
      echo "⚠ DIRECTION.md exists but genesis has $MEMBERS members"
      echo "  First agent should delete DIRECTION.md before others join"
    fi
  fi
  
  exit 0
fi

# Validate commit message format
MSG=$(cat "$MSG_FILE" | head -1)

# Check for structured prefix
if [[ "$MSG" =~ ^\[(join|vote|pass|stuff|complete|evolve|heap-death)\] ]]; then
  echo "✓ Commit message follows convention: $MSG"
  exit 0
fi

# Allow merge commits and other git-generated messages
if [[ "$MSG" =~ ^(Merge|Revert|fixup!|squash!) ]]; then
  exit 0
fi

# Warn but don't block (yet)
echo "⚠ Commit message doesn't follow convention: $MSG"
echo "  Expected: [join|vote|pass|stuff|complete|evolve|heap-death] description"
echo "  Allowing anyway (convention is advisory)"
exit 0
