#!/bin/bash
# zcomplete: Record genesis completion event
#
# Call this when zstate shows action="complete"
# This happens when genesis thresholds are met for the first time

set -e

AGENT="${1:-system}"

bin/zlog zcomplete "Checking if ready to record completion" '{}' 2>/dev/null || true

# Verify we're in the right state
STATE=$(bin/zstate)
ACTION=$(echo "$STATE" | jq -r '.action')
COMPLETE=$(echo "$STATE" | jq -r '.genesis.complete')

if [[ "$ACTION" != "complete" ]]; then
  echo "ERROR: Current action is '$ACTION', not 'complete'" >&2
  echo "Run bin/zstate to see current state" >&2
  exit 1
fi

if [[ "$COMPLETE" != "true" ]]; then
  echo "ERROR: Genesis not complete" >&2
  echo "$STATE" | jq .genesis >&2
  exit 1
fi

# Record the completion event
bin/zevent complete "$AGENT" "genesis complete" '{}'

bin/zlog zcomplete "Completion event recorded - next action will be heap-death" \
  "$(jq -n --arg agent "$AGENT" '{agent: $agent, next_action: "heap-death"}')" 2>/dev/null || true

echo "Completion event recorded. Next agent should run heap-death."
