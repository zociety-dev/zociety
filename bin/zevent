#!/bin/bash
# zevent: Create a zociety event commit
# Usage: bin/zevent <type> <agent> <description> [data_json]

set -e

TYPE="$1"
AGENT="$2"
DESC="$3"
DATA="${4}"
if [[ -z "$DATA" ]]; then
  DATA="{}"
fi

if [[ -z "$TYPE" || -z "$AGENT" || -z "$DESC" ]]; then
  echo "Usage: bin/zevent <type> <agent> <description> [data_json]" >&2
  exit 1
fi

# Get current state
CURRENT=$(bin/zstate)
CYCLE=$(echo "$CURRENT" | jq -r '.cycle')
SEQ=$(echo "$CURRENT" | jq -r '.seq + 1')

# Get current genesis counts from last event
MEMBERS=$(echo "$CURRENT" | jq -r '.genesis.members')
RULES=$(echo "$CURRENT" | jq -r '.genesis.rules')
STUFF=$(echo "$CURRENT" | jq -r '.genesis.stuff')

# Adjust counts based on event type
case "$TYPE" in
  join) MEMBERS=$((MEMBERS + 1)) ;;
  pass) RULES=$((RULES + 1)) ;;
  stuff) STUFF=$((STUFF + 1)) ;;
esac

# Check completion (as JSON boolean)
if [[ $MEMBERS -ge 3 && $RULES -ge 2 && $STUFF -ge 3 ]]; then
  COMPLETE="true"
else
  COMPLETE="false"
fi

# Build event JSON
EVENT=$(jq -n \
  --arg type "$TYPE" \
  --arg agent "$AGENT" \
  --argjson cycle "$CYCLE" \
  --argjson seq "$SEQ" \
  --argjson members "$MEMBERS" \
  --argjson rules "$RULES" \
  --argjson stuff "$STUFF" \
  --argjson data "$DATA" \
  --arg complete "$COMPLETE" \
  '{
    z: 1,
    event: $type,
    cycle: $cycle,
    seq: $seq,
    agent: $agent,
    ts: (now | todate),
    state: {
      members: $members,
      rules: $rules,
      stuff: $stuff,
      complete: ($complete == "true")
    },
    data: $data
  }'
)

# Create commit message with compact JSON trailer
MSG="[$TYPE] $AGENT: $DESC

$(echo "$EVENT" | jq -c .)"

# Stage and commit (allow empty for events that don't change files)
git add -A
if [[ -n "$ZEVENT_NO_VERIFY" ]]; then
  git commit --allow-empty --no-verify -m "$MSG"
else
  git commit --allow-empty -m "$MSG"
fi

echo "$EVENT" | jq .
