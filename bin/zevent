#!/bin/bash
# zevent: Create a zociety event commit
# Usage: bin/zevent <type> <agent> <description> [data_json]

set -e

TYPE="$1"
AGENT="$2"
DESC="$3"
DATA="${4:-{}}"

if [[ -z "$TYPE" || -z "$AGENT" || -z "$DESC" ]]; then
  echo "Usage: bin/zevent <type> <agent> <description> [data_json]" >&2
  exit 1
fi

# Get current state
CURRENT=$(bin/zstate)
CYCLE=$(echo "$CURRENT" | jq -r '.cycle')
SEQ=$(echo "$CURRENT" | jq -r '.seq + 1')

# Count current genesis state from git history
MEMBERS=$(git log --oneline --grep='^\[join\]' 2>/dev/null | wc -l | tr -d ' ')
RULES=$(git log --oneline --grep='^\[pass\]' 2>/dev/null | wc -l | tr -d ' ')
STUFF=$(git ls-files stuff/ 2>/dev/null | wc -l | tr -d ' ')

# Adjust counts based on event type
case "$TYPE" in
  join) MEMBERS=$((MEMBERS + 1)) ;;
  pass) RULES=$((RULES + 1)) ;;
  stuff) STUFF=$((STUFF + 1)) ;;
esac

# Check completion
COMPLETE="false"
[[ $MEMBERS -ge 3 && $RULES -ge 2 && $STUFF -ge 3 ]] && COMPLETE="true"

# Build event JSON
EVENT=$(jq -n \
  --arg type "$TYPE" \
  --arg agent "$AGENT" \
  --argjson cycle "$CYCLE" \
  --argjson seq "$SEQ" \
  --argjson members "$MEMBERS" \
  --argjson rules "$RULES" \
  --argjson stuff "$STUFF" \
  --argjson complete "$COMPLETE" \
  --argjson data "$DATA" \
  '{
    z: 1,
    event: $type,
    cycle: $cycle,
    seq: $seq,
    agent: $agent,
    ts: (now | todate),
    state: {
      members: $members,
      rules: $rules,
      stuff: $stuff,
      complete: $complete
    },
    data: $data
  }'
)

# Create commit message
MSG="[$TYPE] $AGENT: $DESC

$EVENT"

# Stage and commit
git add -A
git commit -m "$MSG"

echo "$EVENT" | jq .
